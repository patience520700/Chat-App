<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L💞venett - Rencontrez de nouvelles personnes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Emoji Picker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/dist/emoji-picker.min.css">
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --dark: #292f36;
            --light: #f7fff7;
            --gray: #e0e0e0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #cce6ff;
            color: var(--dark);
            height: 100vh;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            width: 350px;
            background: #cce6ff;
            border-right: 1px solid var(--gray);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .user-header {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--gray);
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .user-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .user-info p {
            color: #666;
            font-size: 14px;
        }
        
        .search-bar {
            padding: 15px;
            border-bottom: 1px solid var(--gray);
        }
        
        .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--gray);
            outline: none;
        }
        
        .contacts-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray);
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: white;
            border-bottom: 2px solid var(--primary);
        }
        
        .contacts {
            flex: 1;
            overflow-y: auto;
        }
        
        .contact {
            display: flex;
            padding: 15px;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .contact:hover {
            background: #fff;
        }
        
        .contact-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .contact-info {
            flex: 1;
        }
        
        .contact-info h4 {
            font-size: 16px;
            margin-bottom: 3px;
        }
        
        .contact-info p {
            color: #777;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .contact-time {
            margin-left: auto;
            font-size: 12px;
            color: #999;
        }
        
        .contact-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .action-btn.accept {
            background: #4CAF50;
        }
        
        .action-btn.reject {
            background: #f44336;
        }
        
        .unread-badge {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 5px;
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: #cce6ff;
            border-bottom: 1px solid var(--gray);
            display: flex;
            align-items: center;
        }
        
        .chat-header-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }
        
        .chat-header-info h3 {
            font-size: 17px;
        }
        
        .chat-header-info p {
            color: #666;
            font-size: 13px;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #e5ddd5;
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .received {
            align-items: flex-start;
        }
        
        .sent {
            align-items: flex-end;
        }
        
        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            position: relative;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        
        .received .message-content {
            background: white;
            border-top-left-radius: 0;
        }
        
        .sent .message-content {
            background: var(--primary);
            color: white;
            border-top-right-radius: 0;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
        
        .chat-input {
            padding: 15px;
            background: white;
            border-top: 1px solid var(--gray);
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .chat-input-container {
            flex: 1;
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 20px;
            padding: 5px 15px;
            margin-right: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: none;
            outline: none;
            background: transparent;
        }
        
        .send-button {
            background: var(--primary);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .send-button:hover {
            background: #ff5252;
        }
        
        .no-contacts {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Style pour les fichiers/images */
        .file-upload-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 20px;
            margin-right: 10px;
        }
        
        .file-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        .file-message {
            display: flex;
            flex-direction: column;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .file-icon {
            margin-right: 8px;
            font-size: 20px;
        }
        
        .file-name {
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }
        
        /* Emoji Picker Styles */
        .emoji-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 20px;
            margin-right: 10px;
        }
        
        .emoji-picker-container {
            position: absolute;
            bottom: 70px;
            right: 20px;
            z-index: 1000;
            display: none;
        }
        
        /* Message Reactions */
        .message-reactions {
            display: flex;
            margin-top: 5px;
            gap: 5px;
        }
        
        .reaction {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 2px 5px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .reaction:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        
        .reaction-count {
            margin-left: 3px;
            font-size: 10px;
        }
        
        .add-reaction-btn {
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }
        
        .reaction-picker {
            position: absolute;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 5px;
            display: none;
            z-index: 100;
            bottom: 100%;
            right: 0;
        }
        
        .reaction-picker span {
            font-size: 18px;
            margin: 2px;
            cursor: pointer;
            display: inline-block;
        }
        
        .reaction-picker span:hover {
            transform: scale(1.2);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-icon {
            margin-right: 10px;
            font-size: 20px;
            color: var(--primary);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-close {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #999;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                display: none;
            }
            
            .sidebar.active {
                display: flex;
            }
            
            .chat-area {
                display: none;
            }
            
            .chat-area.active {
                display: flex;
            }
            
            .emoji-picker-container {
                bottom: 60px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
  
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="user-header">
            <img  class="user-avatar" id="currentUserAvatar">
            <div class="user-info">
                <h3 id="currentUserName">Chargement...</h3>
                <p>En ligne</p>
            </div>
        </div>
        
        <div class="search-bar">
            <input type="text" placeholder="Rechercher des personnes..." id="searchInput">
        </div>
        
        <div class="contacts-tabs">
            <div class="tab active" data-tab="contacts">Contacts</div>
            <div class="tab" data-tab="invitations">Invitations</div>
            <div class="tab" data-tab="discover">Découvrir</div>
        </div>
        
        <div class="contacts" id="contactsList">
            <!-- Contacts will be loaded here -->
        </div>
    </div>
    
    <!-- Chat Area -->
    <div class="chat-area" id="chatArea">
        <div class="chat-header">
            <img class="chat-header-avatar" id="chatContactAvatar">
            <div class="chat-header-info">
                <h3 id="chatContactName">Sélectionnez un contact</h3>
                <p id="chatContactStatus"></p>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="no-contacts" id="noChatSelected">
                <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px; color: var(--primary);"></i>
                <h3>Bienvenue sur Lovenett</h3>
                <p>Sélectionnez un contact pour commencer à discuter</p>
            </div>
        </div>
        
        <div class="chat-input" style="display: none;" id="chatInputContainer">
            <div class="emoji-picker-container" id="emojiPickerContainer">
                <emoji-picker></emoji-picker>
            </div>
            
            <div class="chat-input-container">
                <button class="file-upload-btn" id="fileUploadBtn" title="Envoyer un fichier">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.txt,.gif">
                
                <button class="emoji-btn" id="emojiBtn" title="Insérer un émoji">
                    <i class="far fa-smile"></i>
                </button>
                
                <input type="text" placeholder="Écrire un message..." id="messageInput">
            </div>
            <button class="send-button" id="sendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon">
            <i class="fas fa-bell"></i>
        </div>
        <div class="notification-content" id="notificationContent"></div>
        <button class="notification-close" id="notificationClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Emoji Picker Element -->
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1.12.0/dist/emoji-picker.min.js"></script>
    
    <script>
        // Variables globales
        let currentChatUser = null;
        let conversations = JSON.parse(localStorage.getItem('conversations')) || {};
        let selectedFile = null;
        let invitations = JSON.parse(localStorage.getItem('invitations')) || {};
        let friends = JSON.parse(localStorage.getItem('friends')) || {};
        let currentTab = 'contacts';
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser) {
                window.location.href = 'forms.html';
                return;
            }
            
            // Afficher les infos utilisateur
            document.getElementById('currentUserName').textContent = currentUser.username;
            document.getElementById('currentUserAvatar').src = currentUser.avatar;
            
            // Initialiser les données si elles n'existent pas
            if (!friends[currentUser.id]) {
                friends[currentUser.id] = [];
            }
            
            // Charger les contacts
            loadContacts();
            
            // Gestion des onglets
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    loadContacts();
                });
            });
            
            // Gestion de la recherche
            document.getElementById('searchInput').addEventListener('input', filterContacts);
            
            // Gestion de l'envoi de messages
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Gestion de l'upload de fichiers
            document.getElementById('fileUploadBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // Gestion du sélecteur d'émojis
            const emojiBtn = document.getElementById('emojiBtn');
            const emojiPickerContainer = document.getElementById('emojiPickerContainer');
            const picker = emojiPickerContainer.querySelector('emoji-picker');
            
            emojiBtn.addEventListener('click', () => {
                emojiPickerContainer.style.display = emojiPickerContainer.style.display === 'block' ? 'none' : 'block';
            });
            
            picker.addEventListener('emoji-click', event => {
                const input = document.getElementById('messageInput');
                input.value += event.detail.unicode;
                input.focus();
            });
            
            // Fermer le sélecteur d'émojis quand on clique ailleurs
            document.addEventListener('click', (e) => {
                if (!emojiBtn.contains(e.target) && !emojiPickerContainer.contains(e.target)) {
                    emojiPickerContainer.style.display = 'none';
                }
            });
            
            // Gestion de la notification
            document.getElementById('notificationClose').addEventListener('click', () => {
                document.getElementById('notification').classList.remove('show');
            });
            
            // Rafraîchir périodiquement les contacts
            setInterval(loadContacts, 5000); // Toutes les 5 secondes
        });
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            
            // Afficher un aperçu si c'est une image
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.createElement('img');
                    preview.src = e.target.result;
                    preview.className = 'file-preview';
                    
                    // Ajouter l'aperçu au message input
                    const messageInput = document.getElementById('messageInput');
                    messageInput.placeholder = "Ajouter un commentaire...";
                    messageInput.parentNode.insertBefore(preview, messageInput.nextSibling);
                };
                reader.readAsDataURL(file);
            } else {
                // Pour les fichiers non-images, afficher le nom du fichier
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                fileInfo.innerHTML = `
                    <i class="fas fa-file file-icon"></i>
                    <span class="file-name">${file.name}</span>
                `;
                
                const messageInput = document.getElementById('messageInput');
                messageInput.placeholder = "Ajouter un commentaire...";
                messageInput.parentNode.insertBefore(fileInfo, messageInput.nextSibling);
            }
        }
        
        function loadContacts() {
            const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            const contactsList = document.getElementById('contactsList');
            
            if (currentTab === 'contacts') {
                // Afficher les amis/contacts
                const userFriends = friends[currentUser.id] || [];
                const contacts = users.filter(user => user.id !== currentUser.id && userFriends.includes(user.id));
                
                if (contacts.length === 0) {
                    contactsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-user-friends" style="font-size: 48px; margin-bottom: 15px; color: var(--primary);"></i>
                            <h3>Aucun contact</h3>
                            <p>Allez dans l'onglet "Découvrir" pour trouver des personnes à ajouter</p>
                        </div>
                    `;
                    return;
                }
                
                contactsList.innerHTML = contacts.map(contact => {
                    // Vérifier s'il y a des messages non lus
                    const conversationId = getConversationId(currentUser.id, contact.id);
                    const unreadCount = conversations[conversationId]?.unreadCount || 0;
                    
                    return `
                        <div class="contact" onclick="openChat('${contact.id}')">
                            <img src="${contact.avatar}" alt="${contact.username}" class="contact-avatar">
                            <div class="contact-info">
                                <h4>${contact.username} ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}</h4>
                                <p>${getLastMessagePreview(conversationId)}</p>
                            </div>
                            <div class="contact-time">${getLastMessageTime(conversationId)}</div>
                        </div>
                    `;
                }).join('');
                
            } else if (currentTab === 'invitations') {
                // Afficher les invitations reçues
                const userInvitations = invitations[currentUser.id] || [];
                
                if (userInvitations.length === 0) {
                    contactsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-envelope" style="font-size: 48px; margin-bottom: 15px; color: var(--primary);"></i>
                            <h3>Aucune invitation</h3>
                            <p>Vous n'avez pas encore reçu d'invitations</p>
                        </div>
                    `;
                    return;
                }
                
                contactsList.innerHTML = userInvitations.map(invitation => {
                    const sender = users.find(user => user.id === invitation.senderId);
                    if (!sender) return '';
                    
                    return `
                        <div class="contact">
                            <img src="${sender.avatar}" alt="${sender.username}" class="contact-avatar">
                            <div class="contact-info">
                                <h4>${sender.username}</h4>
                                <p>Vous a envoyé une invitation</p>
                            </div>
                            <div class="contact-actions">
                                <button class="action-btn accept" onclick="acceptInvitation('${sender.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="action-btn reject" onclick="rejectInvitation('${sender.id}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } else if (currentTab === 'discover') {
                // Afficher tous les utilisateurs (sauf l'utilisateur actuel et ses amis)
                const userFriends = friends[currentUser.id] || [];
                const discoverUsers = users.filter(user => 
                    user.id !== currentUser.id && 
                    !userFriends.includes(user.id) &&
                    !hasPendingInvitation(currentUser.id, user.id)
                );
                
                if (discoverUsers.length === 0) {
                    contactsList.innerHTML = `
                        <div class="no-contacts">
                            <i class="fas fa-globe-americas" style="font-size: 48px; margin-bottom: 15px; color: var(--primary);"></i>
                            <h3>Plus de personnes à découvrir</h3>
                            <p>Revenez plus tard pour découvrir de nouvelles personnes</p>
                        </div>
                    `;
                    return;
                }
                
                contactsList.innerHTML = discoverUsers.map(user => {
                    return `
                        <div class="contact">
                            <img src="${user.avatar}" alt="${user.username}" class="contact-avatar">
                            <div class="contact-info">
                                <h4>${user.username}</h4>
                                <p>Nouveau membre sur Lovenett</p>
                            </div>
                            <button class="action-btn" onclick="sendInvitation('${user.id}')">
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function filterContacts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const contacts = document.querySelectorAll('.contact');
            
            contacts.forEach(contact => {
                const name = contact.querySelector('h4').textContent.toLowerCase();
                contact.style.display = name.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        function openChat(contactId) {
            const users = JSON.parse(localStorage.getItem('registeredUsers'));
            const contact = users.find(user => user.id === contactId);
            
            if (!contact) return;
            
            currentChatUser = contact;
            
            // Mettre à jour l'en-tête du chat
            document.getElementById('chatContactName').textContent = contact.username;
            document.getElementById('chatContactAvatar').src = contact.avatar;
            document.getElementById('chatContactStatus').textContent = "En ligne";
            
            // Afficher la zone de saisie
            document.getElementById('chatInputContainer').style.display = 'flex';
            document.getElementById('noChatSelected').style.display = 'none';
            
            // Charger les messages
            loadMessages(contactId);
            
            // Marquer les messages comme lus
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const conversationId = getConversationId(currentUser.id, contactId);
            if (conversations[conversationId]) {
                conversations[conversationId].unreadCount = 0;
                localStorage.setItem('conversations', JSON.stringify(conversations));
            }
            
            // Actualiser la liste des contacts
            loadContacts();
        }
        
        function sendInvitation(userId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Initialiser les invitations si elles n'existent pas
            if (!invitations[userId]) {
                invitations[userId] = [];
            }
            
            // Vérifier si une invitation a déjà été envoyée
            const hasInvitation = invitations[userId].some(inv => inv.senderId === currentUser.id);
            
            if (hasInvitation) {
                showNotification("Vous avez déjà envoyé une invitation à cette personne");
                return;
            }
            
            // Ajouter l'invitation
            invitations[userId].push({
                senderId: currentUser.id,
                timestamp: new Date().toISOString()
            });
            
            // Sauvegarder dans le localStorage
            localStorage.setItem('invitations', JSON.stringify(invitations));
            
            showNotification("Invitation envoyée avec succès");
            loadContacts();
        }
        
        function acceptInvitation(senderId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Retirer l'invitation
            if (invitations[currentUser.id]) {
                invitations[currentUser.id] = invitations[currentUser.id].filter(inv => inv.senderId !== senderId);
            }
            
            // Ajouter aux amis
            if (!friends[currentUser.id]) {
                friends[currentUser.id] = [];
            }
            if (!friends[senderId]) {
                friends[senderId] = [];
            }
            
            friends[currentUser.id].push(senderId);
            friends[senderId].push(currentUser.id);
            
            // Sauvegarder
            localStorage.setItem('invitations', JSON.stringify(invitations));
            localStorage.setItem('friends', JSON.stringify(friends));
            
            showNotification("Invitation acceptée, vous êtes maintenant amis");
            loadContacts();
        }
        
        function rejectInvitation(senderId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Retirer l'invitation
            if (invitations[currentUser.id]) {
                invitations[currentUser.id] = invitations[currentUser.id].filter(inv => inv.senderId !== senderId);
            }
            
            // Sauvegarder
            localStorage.setItem('invitations', JSON.stringify(invitations));
            
            showNotification("Invitation refusée");
            loadContacts();
        }
        
        function hasPendingInvitation(currentUserId, targetUserId) {
            // Vérifier si l'utilisateur a déjà envoyé une invitation
            if (invitations[targetUserId]) {
                return invitations[targetUserId].some(inv => inv.senderId === currentUserId);
            }
            return false;
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationContent = document.getElementById('notificationContent');
            
            notificationContent.textContent = message;
            notification.classList.add('show');
            
            // Masquer automatiquement après 3 secondes
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function loadMessages(contactId) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const conversationId = getConversationId(currentUser.id, contactId);
            const conversation = conversations[conversationId] || { messages: [] };
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            
            if (conversation.messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="no-contacts">
                        <i class="fas fa-comment-alt" style="font-size: 48px; margin-bottom: 15px; color: var(--primary);"></i>
                        <h3>Commencez la conversation</h3>
                        <p>Envoyez votre premier message à ${currentChatUser.username}</p>
                    </div>
                `;
                return;
            }
            
            conversation.messages.forEach(message => {
                const isReceived = message.senderId !== currentUser.id;
                const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isReceived ? 'received' : 'sent'}`;
                messageElement.dataset.messageId = message.id;
                
                if (message.file) {
                    // Afficher un message avec fichier/image
                    if (message.file.type.startsWith('image/') || message.file.type === 'image/gif') {
                        messageElement.innerHTML = `
                            <div class="message-content file-message">
                                <img src="${message.file.url}" class="file-preview">
                                ${message.content ? `<p>${message.content}</p>` : ''}
                                <div class="message-time">${time}</div>
                                ${renderReactions(message.reactions)}
                            </div>
                        `;
                    } else {
                        messageElement.innerHTML = `
                            <div class="message-content file-message">
                                <div class="file-info">
                                    <i class="fas fa-file file-icon"></i>
                                    <span class="file-name">${message.file.name}</span>
                                </div>
                                ${message.content ? `<p>${message.content}</p>` : ''}
                                <div class="message-time">${time}</div>
                                ${renderReactions(message.reactions)}
                            </div>
                        `;
                    }
                } else {
                    // Message texte normal
                    messageElement.innerHTML = `
                        <div class="message-content">
                            ${message.content}
                            <div class="message-time">${time}</div>
                            ${renderReactions(message.reactions)}
                        </div>
                    `;
                }
                
                chatMessages.appendChild(messageElement);
            });
            
            // Ajouter les gestionnaires d'événements pour les réactions
            setupReactionHandlers();
            
            // Faire défiler vers le bas
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function renderReactions(reactions) {
            if (!reactions || Object.keys(reactions).length === 0) {
                return `<div class="message-reactions"><button class="add-reaction-btn">+</button></div>`;
            }
            
            let html = '<div class="message-reactions">';
            
            // Afficher les réactions existantes
            for (const [emoji, users] of Object.entries(reactions)) {
                html += `
                    <div class="reaction" data-emoji="${emoji}">
                        ${emoji} <span class="reaction-count">${users.length}</span>
                    </div>
                `;
            }
            
            // Bouton pour ajouter une nouvelle réaction
            html += '<button class="add-reaction-btn">+</button></div>';
            
            return html;
        }
        
        function setupReactionHandlers() {
            // Gestionnaire pour le bouton "ajouter une réaction"
            document.querySelectorAll('.add-reaction-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Fermer tous les autres sélecteurs de réaction
                    document.querySelectorAll('.reaction-picker').forEach(picker => {
                        picker.style.display = 'none';
                    });
                    
                    // Créer ou afficher le sélecteur de réaction
                    const messageElement = this.closest('.message');
                    const messageId = messageElement.dataset.messageId;
                    
                    let picker = messageElement.querySelector('.reaction-picker');
                    if (!picker) {
                        picker = document.createElement('div');
                        picker.className = 'reaction-picker';
                        
                        // Liste des émojis de réaction courants
                        const commonReactions = ['👍', '❤️', '😂', '😮', '😢', '🙏'];
                        
                        commonReactions.forEach(emoji => {
                            const span = document.createElement('span');
                            span.textContent = emoji;
                            span.addEventListener('click', () => addReaction(messageId, emoji));
                            picker.appendChild(span);
                        });
                        
                        messageElement.appendChild(picker);
                    }
                    
                    picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
                });
            });
            
            // Gestionnaire pour les réactions existantes
            document.querySelectorAll('.reaction').forEach(reaction => {
                reaction.addEventListener('click', function() {
                    const messageElement = this.closest('.message');
                    const messageId = messageElement.dataset.messageId;
                    const emoji = this.dataset.emoji;
                    addReaction(messageId, emoji);
                });
            });
        }
        
        function addReaction(messageId, emoji) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const conversationId = getConversationId(currentUser.id, currentChatUser.id);
            
            if (!conversations[conversationId]) return;
            
            // Trouver le message
            const message = conversations[conversationId].messages.find(m => m.id === messageId);
            if (!message) return;
            
            // Initialiser les réactions si elles n'existent pas
            if (!message.reactions) {
                message.reactions = {};
            }
            
            // Initialiser la réaction si elle n'existe pas
            if (!message.reactions[emoji]) {
                message.reactions[emoji] = [];
            }
            
            // Vérifier si l'utilisateur a déjà réagi avec cet émoji
            const userIndex = message.reactions[emoji].indexOf(currentUser.id);
            
            if (userIndex === -1) {
                // Ajouter la réaction
                message.reactions[emoji].push(currentUser.id);
            } else {
                // Retirer la réaction
                message.reactions[emoji].splice(userIndex, 1);
                
                // Supprimer la réaction si personne ne l'utilise plus
                if (message.reactions[emoji].length === 0) {
                    delete message.reactions[emoji];
                }
            }
            
            // Mettre à jour le stockage local
            localStorage.setItem('conversations', JSON.stringify(conversations));
            
            // Recharger les messages pour afficher les nouvelles réactions
            loadMessages(currentChatUser.id);
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if ((message || selectedFile) && currentChatUser) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                const conversationId = getConversationId(currentUser.id, currentChatUser.id);
                
                // Créer la conversation si elle n'existe pas
                if (!conversations[conversationId]) {
                    conversations[conversationId] = {
                        participants: [currentUser.id, currentChatUser.id],
                        messages: [],
                        unreadCount: 0
                    };
                }
                
                // Créer le nouveau message
                const newMessage = {
                    id: Date.now().toString(),
                    senderId: currentUser.id,
                    content: message,
                    timestamp: new Date().toISOString()
                };
                
                // Ajouter les informations du fichier si un fichier est sélectionné
                if (selectedFile) {
                    newMessage.file = {
                        name: selectedFile.name,
                        type: selectedFile.type,
                        size: selectedFile.size,
                        // Dans une application réelle, vous devriez uploader le fichier sur un serveur
                        // et stocker l'URL ici. Pour cette démo, nous utilisons un Data URL
                        url: URL.createObjectURL(selectedFile)
                    };
                }
                
                conversations[conversationId].messages.push(newMessage);
                localStorage.setItem('conversations', JSON.stringify(conversations));
                
                // Afficher le message dans le chat
                displayMessage(newMessage, true);
                
                // Réinitialiser l'input et le fichier sélectionné
                input.value = '';
                selectedFile = null;
                
                // Supprimer les aperçus de fichiers
                const previews = document.querySelectorAll('.file-preview, .file-info');
                previews.forEach(preview => preview.remove());
                input.placeholder = "Écrire un message...";
                
                // Faire défiler vers le bas
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        function displayMessage(message, isSent) {
            const chatMessages = document.getElementById('chatMessages');
            const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            messageElement.dataset.messageId = message.id;
            
            if (message.file) {
                // Afficher un message avec fichier/image
                if (message.file.type.startsWith('image/') || message.file.type === 'image/gif') {
                    messageElement.innerHTML = `
                        <div class="message-content file-message">
                            <img src="${message.file.url}" class="file-preview">
                            ${message.content ? `<p>${message.content}</p>` : ''}
                            <div class="message-time">${time}</div>
                            ${renderReactions(message.reactions)}
                        </div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="message-content file-message">
                            <div class="file-info">
                                <i class="fas fa-file file-icon"></i>
                                <span class="file-name">${message.file.name}</span>
                            </div>
                            ${message.content ? `<p>${message.content}</p>` : ''}
                            <div class="message-time">${time}</div>
                            ${renderReactions(message.reactions)}
                        </div>
                    `;
                }
            } else {
                // Message texte normal
                messageElement.innerHTML = `
                    <div class="message-content">
                        ${message.content}
                        <div class="message-time">${time}</div>
                        ${renderReactions(message.reactions)}
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageElement);
            
            // Ajouter les gestionnaires d'événements pour les réactions
            setupReactionHandlers();
        }
        
        function getConversationId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }
        
        function getLastMessagePreview(conversationId) {
            if (!conversations[conversationId] || conversations[conversationId].messages.length === 0) {
                return "Aucun message";
            }
            
            const lastMessage = conversations[conversationId].messages.slice(-1)[0];
            
            if (lastMessage.file) {
                if (lastMessage.file.type.startsWith('image/')) {
                    return "📷 Photo";
                } else if (lastMessage.file.type === 'image/gif') {
                    return "🎬 GIF";
                } else {
                    return "📄 Fichier";
                }
            }
            
            // Vérifier s'il y a des émojis dans le message
            const emojiRegex = /[\p{Emoji}]/gu;
            const hasEmoji = emojiRegex.test(lastMessage.content);
            
            if (hasEmoji) {
                const emojis = lastMessage.content.match(emojiRegex);
                return emojis.join('') + (lastMessage.content.length > emojis.length ? '...' : '');
            }
            
            return lastMessage.content.length > 20 
                ? lastMessage.content.substring(0, 20) + '...' 
                : lastMessage.content;
        }
        
        function getLastMessageTime(conversationId) {
            if (!conversations[conversationId] || conversations[conversationId].messages.length === 0) {
                return "";
            }
            
            const lastMessage = conversations[conversationId].messages.slice(-1)[0];
            const messageDate = new Date(lastMessage.timestamp);
            const today = new Date();
            
            if (messageDate.toDateString() === today.toDateString()) {
                return messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                return messageDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }
    </script>
    
</body>
</html>